import { useContext, useState, useEffect } from 'react';
import { LoadingContext } from '../../../context/context';
import { AdminService } from '../../../services/admin.service';
import toast from 'react-hot-toast';
import { FaFileAlt, FaSearch, FaUpload, FaDownload, FaTrash, FaEdit, FaFilter } from "react-icons/fa";
import { Modal, Button, Form } from 'react-bootstrap';
import "../SharedPage.css";
import "./Documentation.css";

export default function Documentation() {
  const { loading, setLoading }: any = useContext(LoadingContext);

  const [documents, setDocuments] = useState<any[]>([]);
  const [filteredDocuments, setFilteredDocuments] = useState<any[]>([]);
  const [searchText, setSearchText] = useState<string>('');
  const [selectedCategory, setSelectedCategory] = useState<string>('');
  const [categories, setCategories] = useState<string[]>([]);

  // Upload Modal
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [uploadFile, setUploadFile] = useState<File | null>(null);
  const [uploadTitle, setUploadTitle] = useState('');
  const [uploadDescription, setUploadDescription] = useState('');
  const [uploadCategory, setUploadCategory] = useState('General');
  const [uploadTags, setUploadTags] = useState('');

  // Edit Modal
  const [showEditModal, setShowEditModal] = useState(false);
  const [editingDoc, setEditingDoc] = useState<any>(null);

  useEffect(() => {
    fetchDocuments();
    fetchCategories();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    filterDocuments();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchText, selectedCategory, documents]);

  const fetchDocuments = async () => {
    setLoading(true);
    try {
      const res = await AdminService.getAllDocumentation();
      if (res.status === 200 && res.data.success) {
        setDocuments(res.data.data);
        setFilteredDocuments(res.data.data);
      }
    } catch (err: any) {
      toast.error(err?.response?.data?.message || "Error fetching documents");
    } finally {
      setLoading(false);
    }
  };

  const fetchCategories = async () => {
    try {
      const res = await AdminService.getDocumentationCategories();
      if (res.status === 200 && res.data.success) {
        setCategories(res.data.data);
      }
    } catch (err) {
      console.error("Error fetching categories:", err);
    }
  };

  const filterDocuments = () => {
    let filtered = [...documents];

    // Filter by search text
    if (searchText.trim()) {
      const search = searchText.toLowerCase();
      filtered = filtered.filter((doc: any) =>
        doc.title?.toLowerCase().includes(search) ||
        doc.description?.toLowerCase().includes(search) ||
        doc.fileName?.toLowerCase().includes(search) ||
        doc.tags?.some((tag: string) => tag.toLowerCase().includes(search))
      );
    }

    // Filter by category
    if (selectedCategory && selectedCategory !== 'All') {
      filtered = filtered.filter((doc: any) => doc.category === selectedCategory);
    }

    setFilteredDocuments(filtered);
  };

  const handleUpload = async () => {
    if (!uploadFile || !uploadTitle.trim()) {
      toast.error("Please provide a title and select a file");
      return;
    }

    const formData = new FormData();
    formData.append('file', uploadFile);
    formData.append('title', uploadTitle);
    formData.append('description', uploadDescription);
    formData.append('category', uploadCategory);

    if (uploadTags.trim()) {
      const tagsArray = uploadTags.split(',').map(tag => tag.trim()).filter(tag => tag);
      formData.append('tags', JSON.stringify(tagsArray));
    }

    try {
      setLoading(true);
      const res = await AdminService.uploadDocumentation(formData);
      if (res.status === 201 && res.data.success) {
        toast.success("Document uploaded successfully");
        setShowUploadModal(false);
        resetUploadForm();
        fetchDocuments();
        fetchCategories();
      }
    } catch (err: any) {
      toast.error(err?.response?.data?.message || "Error uploading document");
    } finally {
      setLoading(false);
    }
  };

  const handleEdit = async () => {
    if (!editingDoc || !editingDoc.title.trim()) {
      toast.error("Title is required");
      return;
    }

    try {
      setLoading(true);
      const updateData: any = {
        title: editingDoc.title,
        description: editingDoc.description,
        category: editingDoc.category
      };

      if (editingDoc.tags && Array.isArray(editingDoc.tags)) {
        updateData.tags = JSON.stringify(editingDoc.tags);
      }

      const res = await AdminService.updateDocumentation(editingDoc._id, updateData);
      if (res.status === 200 && res.data.success) {
        toast.success("Document updated successfully");
        setShowEditModal(false);
        setEditingDoc(null);
        fetchDocuments();
        fetchCategories();
      }
    } catch (err: any) {
      toast.error(err?.response?.data?.message || "Error updating document");
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: string, title: string) => {
    if (!confirm(`Are you sure you want to delete "${title}"?`)) {
      return;
    }

    try {
      setLoading(true);
      const res = await AdminService.deleteDocumentation(id);
      if (res.status === 200 && res.data.success) {
        toast.success("Document deleted successfully");
        fetchDocuments();
        fetchCategories();
      }
    } catch (err: any) {
      toast.error(err?.response?.data?.message || "Error deleting document");
    } finally {
      setLoading(false);
    }
  };

  const handleDownload = (url: string, fileName: string) => {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const resetUploadForm = () => {
    setUploadFile(null);
    setUploadTitle('');
    setUploadDescription('');
    setUploadCategory('General');
    setUploadTags('');
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };

  const formatDate = (date: string) => {
    return new Date(date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  return (
    <div className="page-wrapper">
      {/* Page Header */}
      <div className="page-header">
        <h1 className="page-title">
          <div className="page-title-icon">
            <FaFileAlt />
          </div>
          Documentation Center
        </h1>
        <p className="page-subtitle">
          Upload, organize, and access documentation files
        </p>
      </div>

      {/* Stats Cards */}
      <div className="stats-container">
        <div className="stat-card">
          <div className="stat-card-header">
            <span className="stat-card-title">Total Documents</span>
            <div className="stat-card-icon">
              <FaFileAlt />
            </div>
          </div>
          <h2 className="stat-card-value">{documents.length}</h2>
          <p className="stat-card-subtitle">All documents</p>
        </div>

        <div className="stat-card">
          <div className="stat-card-header">
            <span className="stat-card-title">Categories</span>
            <div className="stat-card-icon">
              <FaFilter />
            </div>
          </div>
          <h2 className="stat-card-value">{categories.length}</h2>
          <p className="stat-card-subtitle">Document categories</p>
        </div>

        <div className="stat-card">
          <div className="stat-card-header">
            <span className="stat-card-title">Filtered Results</span>
            <div className="stat-card-icon">
              <FaSearch />
            </div>
          </div>
          <h2 className="stat-card-value">{filteredDocuments.length}</h2>
          <p className="stat-card-subtitle">Current view</p>
        </div>
      </div>

      {/* Action Bar */}
      <div className="action-bar" style={{ marginTop: '2rem', display: 'flex', gap: '1rem', flexWrap: 'wrap', alignItems: 'center' }}>
        {/* Category Filter */}
        <select
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value)}
          style={{
            padding: '0.625rem 1rem',
            border: '1px solid var(--border-color)',
            borderRadius: '8px',
            background: 'var(--card-bg)',
            color: 'var(--text-primary)',
            fontSize: '0.875rem',
            cursor: 'pointer'
          }}
        >
          <option value="">All Categories</option>
          {categories.map((category) => (
            <option key={category} value={category}>{category}</option>
          ))}
        </select>

        {/* Upload Button */}
        <button
          onClick={() => setShowUploadModal(true)}
          style={{
            padding: '0.625rem 1.25rem',
            background: 'linear-gradient(135deg, var(--primary-color) 0%, #0056a3 100%)',
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            cursor: 'pointer',
            fontWeight: 600,
            fontSize: '0.875rem',
            transition: 'all 0.2s ease',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem',
          }}
          onMouseEnter={(e) => {
            e.currentTarget.style.transform = 'translateY(-2px)';
            e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 115, 187, 0.3)';
          }}
          onMouseLeave={(e) => {
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = 'none';
          }}
        >
          <FaUpload /> Upload Document
        </button>

        {/* Search Box */}
        <div className="search-box" style={{ flex: 1, minWidth: '300px' }}>
          <FaSearch className="search-icon" />
          <input
            type="text"
            className="search-input"
            placeholder="Search by title, description, or tags..."
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
          />
        </div>
      </div>

      {/* Documents Grid */}
      <div className="documentation-grid" style={{ marginTop: '2rem' }}>
        {filteredDocuments.length === 0 ? (
          <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-secondary)' }}>
            <FaFileAlt size={48} style={{ opacity: 0.3, marginBottom: '1rem' }} />
            <p>No documents found</p>
          </div>
        ) : (
          filteredDocuments.map((doc: any) => (
            <div key={doc._id} className="document-card">
              <div className="document-card-header">
                <FaFileAlt size={32} style={{ color: 'var(--primary-color)' }} />
                <span className="document-category">{doc.category}</span>
              </div>
              <h3 className="document-title">{doc.title}</h3>
              <p className="document-description">{doc.description || 'No description'}</p>

              <div className="document-meta">
                <div className="document-info">
                  <small>File: {doc.fileName}</small>
                  <small>Size: {formatFileSize(doc.fileSize)}</small>
                  <small>Uploaded: {formatDate(doc.createdAt)}</small>
                  <small>By: {doc.uploadedBy}</small>
                </div>

                {doc.tags && doc.tags.length > 0 && (
                  <div className="document-tags">
                    {doc.tags.map((tag: string, index: number) => (
                      <span key={index} className="tag">{tag}</span>
                    ))}
                  </div>
                )}
              </div>

              <div className="document-actions">
                <button
                  onClick={() => handleDownload(doc.downloadUrl, doc.fileName)}
                  className="doc-action-btn download"
                  title="Download"
                >
                  <FaDownload />
                </button>
                <button
                  onClick={() => {
                    setEditingDoc(doc);
                    setShowEditModal(true);
                  }}
                  className="doc-action-btn edit"
                  title="Edit"
                >
                  <FaEdit />
                </button>
                <button
                  onClick={() => handleDelete(doc._id, doc.title)}
                  className="doc-action-btn delete"
                  title="Delete"
                >
                  <FaTrash />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Upload Modal */}
      <Modal show={showUploadModal} onHide={() => setShowUploadModal(false)} centered>
        <Modal.Header closeButton>
          <Modal.Title>Upload Documentation</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form>
            <Form.Group className="mb-3">
              <Form.Label>Title *</Form.Label>
              <Form.Control
                type="text"
                placeholder="Enter document title"
                value={uploadTitle}
                onChange={(e) => setUploadTitle(e.target.value)}
              />
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Description</Form.Label>
              <Form.Control
                as="textarea"
                rows={3}
                placeholder="Enter document description"
                value={uploadDescription}
                onChange={(e) => setUploadDescription(e.target.value)}
              />
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Category</Form.Label>
              <Form.Control
                type="text"
                placeholder="e.g., User Guide, API Docs, Tutorial"
                value={uploadCategory}
                onChange={(e) => setUploadCategory(e.target.value)}
              />
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Tags (comma-separated)</Form.Label>
              <Form.Control
                type="text"
                placeholder="e.g., aws, guide, beginner"
                value={uploadTags}
                onChange={(e) => setUploadTags(e.target.value)}
              />
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>File *</Form.Label>
              <Form.Control
                type="file"
                onChange={(e: any) => setUploadFile(e.target.files[0])}
              />
              {uploadFile && (
                <small className="text-muted">
                  Selected: {uploadFile.name} ({formatFileSize(uploadFile.size)})
                </small>
              )}
            </Form.Group>
          </Form>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={() => setShowUploadModal(false)}>
            Cancel
          </Button>
          <Button variant="primary" onClick={handleUpload} disabled={loading}>
            {loading ? 'Uploading...' : 'Upload'}
          </Button>
        </Modal.Footer>
      </Modal>

      {/* Edit Modal */}
      <Modal show={showEditModal} onHide={() => setShowEditModal(false)} centered>
        <Modal.Header closeButton>
          <Modal.Title>Edit Documentation</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {editingDoc && (
            <Form>
              <Form.Group className="mb-3">
                <Form.Label>Title *</Form.Label>
                <Form.Control
                  type="text"
                  value={editingDoc.title}
                  onChange={(e) => setEditingDoc({ ...editingDoc, title: e.target.value })}
                />
              </Form.Group>

              <Form.Group className="mb-3">
                <Form.Label>Description</Form.Label>
                <Form.Control
                  as="textarea"
                  rows={3}
                  value={editingDoc.description || ''}
                  onChange={(e) => setEditingDoc({ ...editingDoc, description: e.target.value })}
                />
              </Form.Group>

              <Form.Group className="mb-3">
                <Form.Label>Category</Form.Label>
                <Form.Control
                  type="text"
                  value={editingDoc.category}
                  onChange={(e) => setEditingDoc({ ...editingDoc, category: e.target.value })}
                />
              </Form.Group>

              <Form.Group className="mb-3">
                <Form.Label>Tags (comma-separated)</Form.Label>
                <Form.Control
                  type="text"
                  value={editingDoc.tags ? editingDoc.tags.join(', ') : ''}
                  onChange={(e) => {
                    const tags = e.target.value.split(',').map((t: string) => t.trim()).filter((t: string) => t);
                    setEditingDoc({ ...editingDoc, tags });
                  }}
                />
              </Form.Group>
            </Form>
          )}
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={() => setShowEditModal(false)}>
            Cancel
          </Button>
          <Button variant="primary" onClick={handleEdit} disabled={loading}>
            {loading ? 'Saving...' : 'Save Changes'}
          </Button>
        </Modal.Footer>
      </Modal>
    </div>
  );
}
